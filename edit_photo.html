<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사진 올리기 - Keyniverse</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="base.css">
    <link rel="stylesheet" href="layout.css">
    <link rel="stylesheet" href="components.css">
    <link rel="stylesheet" href="forms.css">
    <link rel="stylesheet" href="pages.css">
    <link rel="stylesheet" href="responsive.css">
    <style>
        #image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            border: 2px dashed var(--border-color);
            padding: 10px;
            border-radius: 8px;
            min-height: 100px;
            align-items: center;
            justify-content: center;
        }
        .img-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }
        .dynamic-tag-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .dynamic-tag-group input { flex: 1; }

        /* PC 화면 너비 조정 */
        .form-container {
            max-width: 800px; /* PC 화면에서 폼의 최대 너비 설정 */
            margin: 0 auto; /* 중앙 정렬 */
            padding: 20px; /* 내부 여백 추가 */
        }
    </style>
</head>
<body>
    <header id="mainHeader">
        <div class="container header-container">
            <a href="index.html" class="logo">
                <span class="logo-text-keyni">Keyni</span>
            </a>
            
            <nav>
                <ul>
                    <li><a href="index.html">홈</a></li>
                    <li><a href="community.html">커뮤니티</a></li>
                    <li><a href="gallery.html">갤러리</a></li>
                    <li><a href="reviews.html">리뷰</a></li>
                    <li><a href="guide.html">가이드</a></li>
                </ul>
            </nav>
            
            <div class="user-actions">
                <a href="login.html" class="btn btn-outline">로그인</a>
            </div>

            <button class="mobile-menu-toggle" id="mobileMenuToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <main class="container main-content-area">
        <div class="form-container">
            <h2><i class="fas fa-camera-retro"></i> 갤러리 게시물 수정</h2>
            <form id="uploadForm">
                <div class="form-group">
                    <label for="photo-file">사진 선택 (여러 장 가능)</label>
                    <input type="file" id="photo-file" class="form-control" accept="image/*" multiple style="display: none;">
                    <label for="photo-file" class="btn btn-secondary" style="cursor: pointer; background-color: var(--dark); display: inline-block; width: fit-content;"><i class="fas fa-folder-open"></i> 파일 선택</label>
                    <span id="selected-files-display" style="margin-left: 10px; color: var(--light-gray);">선택된 파일 없음</span>
                    <div id="image-preview-container">
                        <p style="color: var(--light-gray);">이미지 미리보기</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="photo-title">제목</label>
                    <input type="text" id="photo-title" class="form-control" placeholder="게시물 제목을 입력하세요" required>
                </div>
                
                <div class="form-group">
                    <label for="photo-description">내용</label>
                    <textarea id="photo-description" class="form-control" rows="8" placeholder="사진에 대한 설명, 사용된 장비 정보 등을 자유롭게 작성해주세요."></textarea>
                </div>

                <div class="form-group">
                    <label>장비 정보 태그 (선택 사항)</label>
                    <p class="form-hint">사진 속 장비 정보를 태그로 남겨 다른 유저들과 공유해보세요!</p>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-keyboard"></i>&nbsp;키보드</span>
                        <input type="text" class="form-control" placeholder="예: Keychron Q1">
                    </div>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-dice-d6"></i>&nbsp;키캡</span>
                        <input type="text" class="form-control" placeholder="예: GMK Laser">
                    </div>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-toggle-on"></i>&nbsp;스위치</span>
                        <input type="text" class="form-control" placeholder="예: Gazzew Boba U4T">
                    </div>
                    <div id="dynamic-tags-container"></div>
                    <button type="button" id="add-tag-btn" class="btn btn-secondary btn-sm"><i class="fas fa-plus"></i> 태그 추가</button>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="history.back()">취소</button>
                    <button type="submit" class="btn btn-primary">작성 완료</button>
                </div>
            </form>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>Keyniverse</h3>
                    <p style="color: var(--light-gray); margin-bottom: 20px;">키보드 오타쿠들의 성지</p>
                </div>
                
                <div class="footer-column">
                    <h3>고객 지원</h3>
                    <ul class="footer-links">
                        <li><a href="#"><i class="fas fa-bullhorn"></i> 공지사항</a></li>
                        <li><a href="#"><i class="fas fa-headset"></i> 문의하기</a></li>
                        <li><a href="#"><i class="fas fa-exclamation-circle"></i> 신고하기</a></li>
                        <li><a href="#"><i class="fas fa-info-circle"></i> 이용약관</a></li>
                        <li><a href="#"><i class="fas fa-shield-alt"></i> 개인정보처리방침</a></li>
                        <li><a href="#"><i class="fas fa-envelope"></i> Contact</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="copyright">
                <p id="copyright-text">&copy; 2025 Keyniverse. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="script.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('photo-file');
            const previewContainer = document.getElementById('image-preview-container');
            const selectedFilesDisplay = document.getElementById('selected-files-display');
            const uploadForm = document.getElementById('uploadForm');
            const addTagBtn = document.getElementById('add-tag-btn');
            const dynamicTagsContainer = document.getElementById('dynamic-tags-container');
            const photoTitleInput = document.getElementById('photo-title');
            const photoDescriptionTextarea = document.getElementById('photo-description');

            let uploadedImages = []; // To store Base64 encoded images
            let editingPostId = null; // To store the ID of the post being edited

            // Check if in edit mode
            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('id');

            if (!postId) {
                alert('수정할 게시물 ID가 필요합니다.');
                window.location.href = 'gallery.html'; // 갤러리 페이지로 리다이렉트
                return;
            }

            editingPostId = parseInt(postId); // postId를 숫자형으로 변환

            document.querySelector('button[type="submit"]').textContent = '수정 완료';

            let galleryItems = JSON.parse(localStorage.getItem('galleryItems')) || [];

            const postToEdit = galleryItems.find(item => {
                return item.id === editingPostId;
            });

            if (!postToEdit) {
                alert('수정할 게시물을 찾을 수 없습니다.');
                window.location.href = 'gallery.html';
                return;
            }

            photoTitleInput.value = postToEdit.title;
            photoDescriptionTextarea.value = postToEdit.description;
            uploadedImages = postToEdit.images || [];

            // Display existing images
            previewContainer.innerHTML = '';
            if (uploadedImages.length > 0) {
                uploadedImages.forEach(imgSrc => {
                    const img = document.createElement('img');
                    img.src = imgSrc;
                    img.classList.add('img-preview');
                    previewContainer.appendChild(img);
                });
                // Display file names for existing images (if available, otherwise a placeholder)
                selectedFilesDisplay.textContent = `기존 이미지 ${uploadedImages.length}개`;
            } else {
                previewContainer.innerHTML = '<p style="color: var(--light-gray);">이미지 미리보기</p>';
                selectedFilesDisplay.textContent = '선택된 파일 없음';
            }

            // Populate existing tags
            for (const tagName in postToEdit.tags) {
                if (postToEdit.tags.hasOwnProperty(tagName)) {
                    let foundPredefined = false;
                    document.querySelectorAll('.input-group').forEach(group => {
                        const textSpan = group.querySelector('.input-group-text');
                        const input = group.querySelector('input');
                        if (textSpan && input && textSpan.textContent.trim().includes(tagName)) {
                            input.value = postToEdit.tags[tagName];
                            foundPredefined = true;
                        }
                    });
                    if (!foundPredefined) {
                        // Add as dynamic tag
                        const newTagGroup = document.createElement('div');
                        newTagGroup.classList.add('dynamic-tag-group', 'input-group');

                        const tagNameInput = document.createElement('input');
                        tagNameInput.type = 'text';
                        tagNameInput.classList.add('form-control');
                        tagNameInput.value = tagName;
                        
                        const tagValueInput = document.createElement('input');
                        tagValueInput.type = 'text';
                        tagValueInput.classList.add('form-control');
                        tagValueInput.value = postToEdit.tags[tagName];

                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.classList.add('btn', 'btn-danger', 'btn-sm');
                        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                        removeBtn.onclick = function() {
                            newTagGroup.remove();
                        }

                        newTagGroup.appendChild(tagNameInput);
                        newTagGroup.appendChild(tagValueInput);
                        newTagGroup.appendChild(removeBtn);
                        dynamicTagsContainer.appendChild(newTagGroup);
                    }
                }
            }

            fileInput.addEventListener('change', function() {
                previewContainer.innerHTML = ''; // Clear previous previews
                uploadedImages = []; // Clear previous images
                if (this.files.length > 0) {
                    const fileNames = Array.from(this.files).map(file => file.name);
                    selectedFilesDisplay.textContent = fileNames.join(', ');
                    Array.from(this.files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.classList.add('img-preview');
                            previewContainer.appendChild(img);
                            uploadedImages.push(e.target.result); // Store Base64 string
                        }
                        reader.readAsDataURL(file);
                    });
                } else {
                    previewContainer.innerHTML = '<p style="color: var(--light-gray);">이미지 미리보기</p>';
                    selectedFilesDisplay.textContent = '선택된 파일 없음';
                }
            });

            addTagBtn.addEventListener('click', function() {
                const newTagGroup = document.createElement('div');
                newTagGroup.classList.add('dynamic-tag-group', 'input-group');

                const tagNameInput = document.createElement('input');
                tagNameInput.type = 'text';
                tagNameInput.classList.add('form-control');
                tagNameInput.placeholder = '태그 이름 (예: 마우스)';
                
                const tagValueInput = document.createElement('input');
                tagValueInput.type = 'text';
                tagValueInput.classList.add('form-control');
                tagValueInput.placeholder = '태그 값 (예: Logitech G Pro)';

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.classList.add('btn', 'btn-danger', 'btn-sm');
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.onclick = function() {
                    newTagGroup.remove();
                }

                newTagGroup.appendChild(tagNameInput);
                newTagGroup.appendChild(tagValueInput);
                newTagGroup.appendChild(removeBtn);
                dynamicTagsContainer.appendChild(newTagGroup);
            });

            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault(); // Prevent default form submission

                const title = photoTitleInput.value;
                const description = photoDescriptionTextarea.value;

                // Collect predefined tags
                const tags = {};
                document.querySelectorAll('.input-group').forEach(group => {
                    const textSpan = group.querySelector('.input-group-text');
                    const input = group.querySelector('input');
                    if (textSpan && input && input.value.trim() !== '') {
                        const tagName = textSpan.textContent.trim().replace(/\s*\S+$/, ''); // Extract tag name without icon
                        tags[tagName] = input.value.trim();
                    }
                });

                // Collect dynamic tags
                document.querySelectorAll('#dynamic-tags-container .dynamic-tag-group').forEach(group => {
                    const tagNameInput = group.querySelectorAll('input')[0];
                    const tagValueInput = group.querySelectorAll('input')[1];
                    if (tagNameInput && tagValueInput && tagNameInput.value.trim() !== '') {
                        tags[tagNameInput.value.trim()] = tagValueInput.value.trim();
                    }
                });

                let galleryItems = JSON.parse(localStorage.getItem('galleryItems')) || [];

                // Update existing post
                const postIndex = galleryItems.findIndex(item => item.id === editingPostId);
                if (postIndex !== -1) {
                    galleryItems[postIndex].title = title;
                    galleryItems[postIndex].description = description;
                    galleryItems[postIndex].images = uploadedImages;
                    galleryItems[postIndex].tags = tags;
                    // Keep original author, date, likes, comments
                } else {
                    alert('수정할 게시물을 찾을 수 없습니다. (ID 불일치)'); // 추가적인 디버깅 알림
                }
                alert('게시물이 성공적으로 수정되었습니다!');

                // Save updated gallery items back to localStorage
                localStorage.setItem('galleryItems', JSON.stringify(galleryItems));

                window.location.href = `gallery_detail.html?id=${editingPostId}`; // Redirect to gallery detail page
            });
        });
    </script>
</body>
</html>